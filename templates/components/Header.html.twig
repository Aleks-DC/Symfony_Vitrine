<header id="site-header" class="sticky top-0 z-50 bg-transparent translate-y-0
          transition-transform duration-500 md:duration-700 ease-in-out will-change-transform">
    <nav aria-label="Global" class="flex items-center justify-between p-6 lg:px-8">
        <div class="flex lg:flex-1">
            <a href="#" class="-m-1.5 p-1.5">
                <span class="sr-only">{{ brand.name }}</span>
                <img src="{{ brand.logo.src }}" alt="{{ brand.logo.alt }}" class="h-8 w-auto" />
            </a>
        </div>

        <div class="flex lg:hidden">
            <button type="button"
                    command="show-modal"
                    commandfor="{{ mobile.dialog_id }}"
                    class="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-400">
                <span class="sr-only">Open main menu</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
                    <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>

        <div class="hidden lg:flex lg:gap-x-12">
            {% for item in menu %}
                <a href="{{ item.href }}" class="text-sm/6 font-semibold text-white inline-flex items-center border-b-2 border-transparent px-1 pt-1 hover:border-gray-300 hover:text-gray-700 dark:text-gray-300 dark:hover:border-white/20 dark:hover:text-white">
                    {{ item.label }}
                </a>
            {% endfor %}
        </div>

        <div class="hidden lg:flex lg:flex-1 lg:justify-end">
            <a href="{{ auth.login_href }}" class="text-sm/6 font-semibold text-white">
                {{ auth.login_label }} <span aria-hidden="true">&rarr;</span>
            </a>
        </div>
    </nav>

    {# Mobile dialog #}
    <el-dialog>
        <dialog id="{{ mobile.dialog_id }}" class="backdrop:bg-transparent lg:hidden">
            <div tabindex="0" class="fixed inset-0 focus:outline-none">
                <el-dialog-panel class="fixed inset-y-0 right-0 z-50 w-full overflow-y-auto bg-gray-900 p-6
                           sm:max-w-sm sm:ring-1 sm:ring-gray-100/10">
                    <div class="flex items-center justify-between">
                        <a href="#" class="-m-1.5 p-1.5">
                            <span class="sr-only">{{ brand.name }}</span>
                            <img src="{{ brand.logo.src }}" alt="{{ brand.logo.alt }}" class="h-8 w-auto" />
                        </a>
                        <button type="button"
                                command="close"
                                commandfor="{{ mobile.dialog_id }}"
                                class="-m-2.5 rounded-md p-2.5 text-gray-400">
                            <span class="sr-only">Close menu</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
                                <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>

                    <div class="mt-6 flow-root">
                        <div class="-my-6 divide-y divide-gray-500/25">
                            <div class="space-y-2 py-6">
                                {% for item in menu %}
                                    <a href="{{ item.href }}"
                                       command="close"
                                       commandfor="{{ mobile.dialog_id }}"
                                       class="-mx-3 block rounded-lg px-3 py-2 text-base/7 font-semibold text-white hover:bg-white/5">
                                        {{ item.label }}
                                    </a>
                                {% endfor %}
                            </div>
                            <div class="py-6">
                                <a href="{{ auth.login_href }}"
                                   class="-mx-3 block rounded-lg px-3 py-2.5 text-base/7 font-semibold text-white hover:bg-white/5">
                                    {{ auth.login_label }}
                                </a>
                            </div>
                        </div>
                    </div>
                </el-dialog-panel>
            </div>
        </dialog>
    </el-dialog>
</header>

<script>
    (function () {
        const header = document.getElementById('site-header');
        if (!header) return;

        const nav = header.querySelector('nav[aria-label="Global"]') || header.querySelector('nav') || header;
        const dlg = document.getElementById('{{ mobile.dialog_id }}');
        const mqDesktop = window.matchMedia('(min-width: 1024px)'); // Tailwind lg

        /* --header-h */
        const setHeaderH = () => {
            const h = nav ? Math.round(nav.getBoundingClientRect().height) : 0;
            document.documentElement.style.setProperty('--header-h', h + 'px');
        };
        setHeaderH();
        addEventListener('load', setHeaderH, { passive: true });
        addEventListener('resize', setHeaderH, { passive: true });

        /* helpers */
        const showHeader = () => { header.classList.remove('-translate-y-full'); header.classList.add('translate-y-0'); };
        const hideHeader = () => { header.classList.remove('translate-y-0');   header.classList.add('-translate-y-full'); };

        /* teinte + blur très léger quand on n’est plus tout en haut */
        const setRaised = () => {
            const s = window.scrollY > 4; // top de page = pas d'effet

            // LÉGER TINT + BLUR
            header.classList.toggle('supports-[backdrop-filter]:backdrop-blur-[8px]', s); // blur ≈ 8px
            header.classList.toggle('supports-[backdrop-filter]:bg-gray-900/25', s);      // très légère teinte quand le blur est supporté

            // Fallback (si pas de support du backdrop-filter) : une teinte plus douce
            header.classList.toggle('bg-gray-900/30', s);

            // séparation subtile (garde si tu aimes)
            header.classList.toggle('border-b', s);
            header.classList.toggle('border-white/10', s);
            header.classList.toggle('shadow-sm', s);

            // Quand on revient tout en haut, on enlève tout
            if (!s) {
                header.classList.remove('backdrop-blur', 'supports-[backdrop-filter]:backdrop-blur-[2px]');
                header.classList.remove('supports-[backdrop-filter]:bg-gray-900/25', 'bg-gray-900/30');
                header.classList.remove('border-b', 'border-white/10', 'shadow-sm');
            }
        };

        /* auto-hide + hystérésis */
        let lastY = window.scrollY;
        let downTravel = 0;
        let hiddenAtY  = null;
        let ticking    = false;
        const MIN_DELTA    = 2;
        const HIDE_AFTER   = 64;
        const REVEAL_AFTER = 48;

        /* LOCK visible (desktop) tant que la cible n'est pas atteinte */
        let lockVisible = false;
        let lockTarget  = null;    // élément de la section visée
        let lockTargetSMT = 0;     // son scroll-margin-top (pour l'alignement)
        const NEAR_PX = 2;         // tolérance en px

        const onScrollRaf = () => {
            const y  = window.scrollY;
            const dy = y - lastY;
            lastY = y;

            setRaised();

            // Si lock actif (clic desktop), on garde visible JUSQU'À ce que la cible soit atteinte
            if (lockVisible) {
                showHeader();

                if (lockTarget) {
                    const top = lockTarget.getBoundingClientRect().top; // relatif au viewport
                    // Quand l'élément est aligné (avec son scroll-margin-top), on libère le lock
                    if (Math.abs(top - lockTargetSMT) <= NEAR_PX) {
                        lockVisible = false;
                        lockTarget  = null;
                        hiddenAtY   = null;
                        downTravel  = 0;
                    }
                }
                // tant que le lock est actif, on ne laisse PAS l'auto-hide agir
                ticking = false;
                return;
            }

            if (Math.abs(dy) < MIN_DELTA) { ticking = false; return; }

            if (dy > 0) { // on descend
                downTravel += dy;
                if (downTravel > HIDE_AFTER && y > 64) {
                    hideHeader();
                    hiddenAtY = y;
                    downTravel = 0;
                }
            } else {      // on remonte
                if (hiddenAtY !== null && (hiddenAtY - y) > REVEAL_AFTER) {
                    showHeader();
                    hiddenAtY = null;
                }
                if (Math.abs(dy) > MIN_DELTA) downTravel = 0;
            }
            ticking = false;
        };

        addEventListener('scroll', () => {
            if (!ticking) { ticking = true; requestAnimationFrame(onScrollRaf); }
        }, { passive: true });

        // état initial
        if (window.scrollY < 8) showHeader();
        setRaised();

        /* CLICS SUR LIENS — Desktop: lock visible jusqu'à alignement de la cible */
        document.addEventListener('click', (e) => {
            const a = e.target.closest('a[href^="#"]');
            if (!a) return;

            if (mqDesktop.matches) {
                const hash = a.getAttribute('href');
                const target = document.querySelector(hash);
                if (!target) return;

                // On ne preventDefault PAS : on laisse l'ancre native (smooth via CSS)
                lockVisible   = true;
                lockTarget    = target;
                lockTargetSMT = parseFloat(getComputedStyle(target).scrollMarginTop) || 0;
                showHeader();
            }
        }, { passive: true });

        /* MOBILE (burger) : fermer, scroller, sans lock (auto-hide normal) */
        if (dlg) {
            dlg.addEventListener('click', function (e) {
                const a = e.target.closest('a[href^="#"]'); if (!a) return;
                const hash = a.getAttribute('href');        if (!hash || hash === '#') return;

                e.preventDefault();
                const go = () => {
                    if (history.pushState) {
                        history.pushState(null, '', hash);
                        document.querySelector(hash)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        location.hash = hash;
                    }
                };

                if (typeof dlg.close === 'function') {
                    dlg.addEventListener('close', go, { once: true });
                    try { dlg.close(); } catch { go(); }
                } else {
                    dlg.removeAttribute('open'); requestAnimationFrame(go);
                }
            }, { passive: false });
        }
    })();
</script>





